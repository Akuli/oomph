#!/bin/bash
set -e

for file in tests/*.code; do
    echo "python3 -m compiler $file"
    if [[ $file == tests/*_error.code ]]; then
        if python3 -m compiler $file 2>test.out; then
            echo "========== SHOULD HAVE ERRORED but it didn't"
            exit 1
        fi
    else
        if ! python3 -m compiler $file > test.out; then
            echo "========== ERROR"
            exit 1
        fi
        diff --color -u tests/output/$(basename $file | cut -d. -f1).txt test.out
    fi
done

echo "
============================= success ============================="

#!/bin/bash
# Add names of all working test files to tests/self_hosted.txt

set -e
make oomphc

cp -v tests/self_hosted.txt tests/self_hosted.txt.tmp

# Preserve tests/blah_error.oomph lines
echo '# List of files that self-hosted compler can compile' > tests/self_hosted.txt
echo "# Generated by $0" >> tests/self_hosted.txt
grep '^tests/.*_error\.oomph$' tests/self_hosted.txt.tmp >> tests/self_hosted.txt

for file in tests/*.oomph; do
    if [[ $file == tests/*_error.oomph ]]; then
        continue
    fi

    echo $file
    if ./oomphc $file >test_out/tmp 2>&1; then
        echo $file >> tests/self_hosted.txt
        LANG=C sort tests/self_hosted.txt -o tests/self_hosted.txt
    fi
    if grep -q KeyboardInterrupt test_out/tmp; then
        mv -v tests/self_hosted.txt.tmp tests/self_hosted.txt
        exit 1
    fi
done

rm -v tests/self_hosted.txt.tmp
